language: c
sudo: required
dist: bionic

services:
  - docker

env:
  - OS=alpine
  - OS=debian
  - OS=arch
  - OS=fedora

install:
- docker build -t bolt-$OS -f ./contrib/Dockerfile-$OS .

script:
  - mkdir build-$OS
  - docker run -e -t -v `pwd`:/src -v `pwd`/build-$OS:/build bolt-$OS ./contrib/docker-build.sh

after_success:
  - if [[ "$OS" == "fedora" ]]; then
      CE=`bash <(curl -s https://codecov.io/env)`;
      curl -o codecov  https://codecov.io/bash && chmod a+x codecov;
      docker run $CE -e OS -t -v `pwd`:/src -v `pwd`/build-$OS:/build bolt-$OS ./codecov -f /build/meson-logs/coverage.info;
    fi
